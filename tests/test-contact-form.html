<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contact Form Tests</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .test-container {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-results {
      margin-top: 20px;
    }
    .test-item {
      padding: 10px;
      margin: 5px 0;
      border-left: 4px solid #ccc;
      background: #f9f9f9;
    }
    .test-item.pass {
      border-color: #4caf50;
      background: #f1f8f4;
    }
    .test-item.fail {
      border-color: #f44336;
      background: #fef5f5;
    }
    .test-item.running {
      border-color: #ff9800;
      background: #fff8f0;
    }
    .summary {
      font-size: 24px;
      font-weight: bold;
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
    }
    .summary.pass {
      background: #4caf50;
      color: white;
    }
    .summary.fail {
      background: #f44336;
      color: white;
    }
    button {
      background: #0078d4;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px 10px 0;
    }
    button:hover {
      background: #005a9e;
    }
    iframe {
      width: 100%;
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>üß™ Contact Form Test Suite</h1>
  <p>Automated testing for the Dynamics 365 contact form template</p>

  <div class="test-container">
    <h2>Test Controls</h2>
    <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
    <button onclick="runHTMLValidation()">‚úì HTML Validation Only</button>
    <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
  </div>

  <div class="test-container">
    <h2>Test Results</h2>
    <div id="summary" class="summary" style="display: none;"></div>
    <div id="results" class="test-results"></div>
  </div>

  <div class="test-container">
    <h2>Form Preview</h2>
    <iframe id="formPreview" src="../templates/contact-form.html"></iframe>
  </div>

  <script>
    let testResults = [];
    let totalTests = 0;
    let passedTests = 0;

    function addResult(testName, passed, message = '') {
      testResults.push({ testName, passed, message });
      updateDisplay();
    }

    function updateDisplay() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      testResults.forEach(result => {
        const div = document.createElement('div');
        div.className = `test-item ${result.passed ? 'pass' : 'fail'}`;
        div.innerHTML = `
          <strong>${result.passed ? '‚úÖ' : '‚ùå'} ${result.testName}</strong>
          ${result.message ? `<br><small>${result.message}</small>` : ''}
        `;
        resultsDiv.appendChild(div);
      });

      // Update summary
      totalTests = testResults.length;
      passedTests = testResults.filter(r => r.passed).length;
      const summary = document.getElementById('summary');
      summary.style.display = 'block';
      summary.className = `summary ${passedTests === totalTests ? 'pass' : 'fail'}`;
      summary.textContent = `${passedTests} / ${totalTests} tests passed`;
    }

    function clearResults() {
      testResults = [];
      totalTests = 0;
      passedTests = 0;
      document.getElementById('results').innerHTML = '';
      document.getElementById('summary').style.display = 'none';
    }

    async function runHTMLValidation() {
      clearResults();
      
      const div = document.createElement('div');
      div.className = 'test-item running';
      div.innerHTML = '<strong>‚è≥ Running HTML Validation...</strong>';
      document.getElementById('results').appendChild(div);

      try {
        // Check if form exists
        const response = await fetch('../templates/contact-form.html');
        const html = await response.text();
        
        // Basic HTML structure checks
        const hasDoctype = html.trim().startsWith('<!DOCTYPE html>');
        addResult('HTML5 Doctype Present', hasDoctype);

        const hasCharset = html.includes('charset="UTF-8"');
        addResult('UTF-8 Charset Declared', hasCharset);

        const hasViewport = html.includes('name="viewport"');
        addResult('Viewport Meta Tag Present', hasViewport);

        const hasTitle = html.includes('<title>') && html.includes('</title>');
        addResult('Title Tag Present', hasTitle);

        const hasForm = html.includes('class="marketingForm"');
        addResult('Marketing Form Element Present', hasForm);

        // Check required Dynamics 365 meta tags
        const hasDynamicsMeta = html.includes('marketing-designer-content-editor-document');
        addResult('Dynamics 365 Meta Tags Present', hasDynamicsMeta);

        // Check for form fields
        const hasFirstName = html.includes('id="firstname"');
        addResult('First Name Field Present', hasFirstName);

        const hasLastName = html.includes('id="lastname"');
        addResult('Last Name Field Present', hasLastName);

        const hasEmail = html.includes('id="emailaddress1"');
        addResult('Email Field Present', hasEmail);

        const hasDescription = html.includes('id="description"');
        addResult('Description Field Present', hasDescription);

        // Check for validation attributes
        const hasRequiredAttrs = html.includes('required');
        addResult('Required Attributes Present', hasRequiredAttrs);

        const hasValidationMessages = html.includes('validation-message');
        addResult('Validation Message Containers Present', hasValidationMessages);

        // Check for JavaScript validation
        const hasValidationJS = html.includes('initFormValidation') || html.includes('validateEmailField');
        addResult('Form Validation JavaScript Present', hasValidationJS);

        // Check for Tailwind CSS
        const hasTailwind = html.includes('tailwindcss.com');
        addResult('Tailwind CSS CDN Present', hasTailwind);

        // Check for modal
        const hasModal = html.includes('id="thankYouModal"');
        addResult('Thank You Modal Present', hasModal);

        div.remove();

      } catch (error) {
        addResult('HTML Validation', false, `Error: ${error.message}`);
        div.remove();
      }
    }

    async function testFormFields() {
      const iframe = document.getElementById('formPreview');
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

      try {
        // Wait for iframe to load
        await new Promise(resolve => {
          if (iframe.contentWindow.document.readyState === 'complete') {
            resolve();
          } else {
            iframe.onload = resolve;
          }
        });

        // Test form exists
        const form = iframeDoc.querySelector('.marketingForm');
        addResult('Form Element Found', !!form);

        if (!form) return;

        // Test form fields
        const firstname = iframeDoc.querySelector('#firstname');
        addResult('First Name Field Exists', !!firstname);
        addResult('First Name Field is Required', firstname?.hasAttribute('required'));

        const lastname = iframeDoc.querySelector('#lastname');
        addResult('Last Name Field Exists', !!lastname);
        addResult('Last Name Field is Required', lastname?.hasAttribute('required'));

        const email = iframeDoc.querySelector('#emailaddress1');
        addResult('Email Field Exists', !!email);
        addResult('Email Field is Required', email?.hasAttribute('required'));
        addResult('Email Field Type is Email', email?.type === 'email');

        const description = iframeDoc.querySelector('#description');
        addResult('Description Field Exists', !!description);
        addResult('Description Field is Required', description?.hasAttribute('required'));

        // Test validation messages
        const validationMessages = iframeDoc.querySelectorAll('.validation-message');
        addResult('Validation Message Elements Present', validationMessages.length >= 3);

        // Test modal
        const modal = iframeDoc.querySelector('#thankYouModal');
        addResult('Thank You Modal Exists', !!modal);

        // Test novalidate attribute (we use custom validation)
        addResult('Custom Validation Enabled (novalidate)', form.hasAttribute('novalidate'));

        // Test JavaScript functions exist
        const hasCloseModal = typeof iframe.contentWindow.closeThankYouModal === 'function';
        addResult('Close Modal Function Exists', hasCloseModal);

        const hasInitValidation = iframeDoc.documentElement.innerHTML.includes('initFormValidation');
        addResult('Form Validation Initialized', hasInitValidation);

      } catch (error) {
        addResult('Form Fields Test', false, `Error: ${error.message}`);
      }
    }

    async function testAccessibility() {
      const iframe = document.getElementById('formPreview');
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

      try {
        // Test labels
        const labels = iframeDoc.querySelectorAll('label');
        const inputs = iframeDoc.querySelectorAll('input, textarea');
        addResult('All Inputs Have Labels', labels.length >= inputs.length - 1); // -1 for checkbox

        // Test label-input associations
        const firstname = iframeDoc.querySelector('#firstname');
        const firstnameLabel = iframeDoc.querySelector('label[for="firstname"]');
        addResult('First Name Label Association', !!firstnameLabel);

        // Test ARIA attributes
        const emailMessage = iframeDoc.querySelector('#emailaddress1-message');
        addResult('Email Validation Message Container Has ID', !!emailMessage);

        // Test form has proper structure
        const formBlocks = iframeDoc.querySelectorAll('[data-editorblocktype]');
        addResult('Dynamics 365 Form Blocks Present', formBlocks.length > 0);

      } catch (error) {
        addResult('Accessibility Test', false, `Error: ${error.message}`);
      }
    }

    async function runAllTests() {
      clearResults();

      const div = document.createElement('div');
      div.className = 'test-item running';
      div.innerHTML = '<strong>‚è≥ Running All Tests...</strong>';
      document.getElementById('results').appendChild(div);

      // Run tests in sequence
      await runHTMLValidation();
      await new Promise(resolve => setTimeout(resolve, 500)); // Wait for iframe
      await testFormFields();
      await testAccessibility();

      div.remove();
    }

    // Run tests on page load
    window.addEventListener('load', () => {
      // Auto-run after a short delay to ensure iframe is loaded
      setTimeout(runAllTests, 1000);
    });
  </script>
</body>
</html>
